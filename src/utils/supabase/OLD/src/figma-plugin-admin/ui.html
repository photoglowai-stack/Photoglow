<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    * { box-sizing: border-box; }
    body {
      font: 13px/1.45 system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      width: 380px;
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      color: #fff;
    }
    .container {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px;
      color: #1a1a1a;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    h3 {
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 500;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }
    input, select, textarea, button {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
    }
    input, select, textarea {
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #ec4899;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }
    button {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #4b5563;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #e5e7eb;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .row > * {
      flex: 1;
    }
    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      line-height: 1.4;
    }
    .kpi {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .kpi-card {
      flex: 1;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    .kpi-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      font-weight: 600;
    }
    .kpi-value {
      font-size: 14px;
      font-weight: 700;
      color: #1a1a1a;
      margin-top: 4px;
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
      color: white;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .footer {
      margin-top: 16px;
      display: flex;
      gap: 10px;
    }
    .log-container {
      margin-top: 16px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      line-height: 1.6;
      color: #a5f3fc;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .log-container::-webkit-scrollbar {
      width: 6px;
    }
    .log-container::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 3px;
    }
    .log-container::-webkit-scrollbar-thumb {
      background: #ec4899;
      border-radius: 3px;
    }
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
      margin: 20px 0;
    }
    .preview-image {
      width: 100%;
      border-radius: 8px;
      margin-top: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .file-input-wrapper {
      position: relative;
      margin-top: 8px;
    }
    .file-input-label {
      display: block;
      padding: 10px 12px;
      background: #f3f4f6;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      color: #6b7280;
    }
    .file-input-label:hover {
      border-color: #ec4899;
      background: #f9fafb;
    }
    .file-input-label.has-file {
      border-style: solid;
      border-color: #ec4899;
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(249, 115, 22, 0.05));
      color: #ec4899;
      font-weight: 600;
    }
    input[type="file"] {
      display: none;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>‚ú® Photoglow Admin ‚Äî Generator</h3>

    <div class="kpi">
      <div class="kpi-card">
        <div class="kpi-label">Mode</div>
        <div class="kpi-value" id="kMode">text2img</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Model</div>
        <div class="kpi-value" id="kModel">FLUX</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ratio</div>
        <div class="kpi-value" id="kAR">1:1</div>
      </div>
    </div>

    <label>AI Model</label>
    <select id="model">
      <option value="flux">FLUX 1.1 Pro (text2img)</option>
      <option value="gen4">Runway Gen‚Äë4</option>
      <option value="gen4-turbo">Runway Gen‚Äë4 Turbo</option>
    </select>

    <div class="row">
      <div>
        <label>Mode</label>
        <select id="mode">
          <option value="text2img">text2img</option>
          <option value="img2img">img2img</option>
        </select>
      </div>
      <div>
        <label>Aspect Ratio</label>
        <select id="ar">
          <option>1:1</option>
          <option>3:4</option>
          <option>4:5</option>
          <option>16:9</option>
          <option>9:16</option>
        </select>
      </div>
    </div>

    <label>Prompt</label>
    <textarea id="prompt" placeholder="professional headshot, studio lighting, 85mm look, crisp details..."></textarea>
    <div class="hint">
      Priority: <span class="pill">preserve exact facial features & likeness</span>
    </div>

    <div class="row" id="psRow" style="display:none">
      <div>
        <label>Prompt Strength</label>
        <input id="ps" type="number" step="0.05" min="0" max="1" value="0.65" />
      </div>
      <div>
        <label>Seed (optional)</label>
        <input id="seed" type="number" placeholder="e.g., 777" />
      </div>
    </div>

    <label>Input Image (img2img)</label>
    <div class="file-input-wrapper">
      <input id="file" type="file" accept="image/*" />
      <label for="file" class="file-input-label" id="fileLabel">
        üìÅ Choose image...
      </label>
    </div>
    <img id="previewImg" class="preview-image" style="display:none" />

    <div class="divider"></div>

    <div class="footer">
      <button id="run" class="btn-primary">
        <span id="btnText">üöÄ Generate</span>
      </button>
      <button id="cancel" class="btn-secondary">‚úï Close</button>
    </div>

    <div class="log-container" id="log"></div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const kMode = document.getElementById('kMode');
    const kModel = document.getElementById('kModel');
    const kAR = document.getElementById('kAR');
    const btnText = document.getElementById('btnText');
    const runBtn = document.getElementById('run');
    const fileLabel = document.getElementById('fileLabel');
    const previewImg = document.getElementById('previewImg');

    function log(x) {
      const timestamp = new Date().toLocaleTimeString();
      const text = typeof x === 'string' ? x : JSON.stringify(x, null, 2);
      logEl.innerHTML += `<div>[${timestamp}] ${text}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    const modelEl = document.getElementById('model');
    const modeEl = document.getElementById('mode');
    const arEl = document.getElementById('ar');
    const psRow = document.getElementById('psRow');
    const fileInput = document.getElementById('file');

    function refreshKPI() {
      kMode.textContent = modeEl.value;
      const modelName = modelEl.value === 'flux' ? 'FLUX' : 
                        modelEl.value === 'gen4' ? 'Gen‚Äë4' : 'Gen‚Äë4 Turbo';
      kModel.textContent = modelName;
      kAR.textContent = arEl.value;
    }

    modeEl.addEventListener('change', () => {
      psRow.style.display = (modeEl.value === 'img2img') ? 'flex' : 'none';
      if (modeEl.value === 'img2img' && modelEl.value === 'flux') {
        modelEl.value = 'gen4'; // UX: FLUX is text2img priority; img2img ‚Üí Gen‚Äë4
      }
      refreshKPI();
    });

    modelEl.addEventListener('change', refreshKPI);
    arEl.addEventListener('change', refreshKPI);

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        fileLabel.textContent = `‚úì ${file.name}`;
        fileLabel.classList.add('has-file');
        
        const reader = new FileReader();
        reader.onload = (ev) => {
          previewImg.src = ev.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        fileLabel.textContent = 'üìÅ Choose image...';
        fileLabel.classList.remove('has-file');
        previewImg.style.display = 'none';
      }
    });

    refreshKPI();

    document.getElementById('cancel').onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    };

    document.getElementById('run').onclick = async () => {
      const model = modelEl.value;
      const mode = modeEl.value;
      const ar = arEl.value;
      const prompt = document.getElementById('prompt').value.trim();
      const ps = parseFloat(document.getElementById('ps').value);
      const seed = document.getElementById('seed').value ? Number(document.getElementById('seed').value) : undefined;
      const file = fileInput.files[0] || null;

      if (!prompt) {
        alert('‚ö†Ô∏è Prompt required');
        return;
      }

      if (mode === 'img2img' && !file) {
        alert('‚ö†Ô∏è Select an input image for img2img mode');
        return;
      }

      runBtn.disabled = true;
      btnText.innerHTML = '<span class="loading-spinner"></span>Generating...';
      log('‚è© Building job request...');

      const msg = {
        type: 'start-job',
        model,
        mode,
        aspect_ratio: ar,
        prompt_final: prompt,
        prompt_strength: (mode === 'img2img' ? ps : undefined),
        seed,
        fileMeta: file ? { name: file.name, type: file.type, size: file.size } : null
      };

      if (file) {
        const buf = await file.arrayBuffer();
        msg.fileBytes = Array.from(new Uint8Array(buf));
      }

      parent.postMessage({ pluginMessage: msg }, '*');
    };

    onmessage = (ev) => {
      const m = ev.data.pluginMessage;
      if (!m) return;

      if (m.type === 'log') {
        log(m.value);
      }

      if (m.type === 'done') {
        log('‚úÖ Generation complete: ' + m.image_url);
        runBtn.disabled = false;
        btnText.innerHTML = 'üöÄ Generate';
      }

      if (m.type === 'error') {
        log('‚ùå Error: ' + m.message);
        runBtn.disabled = false;
        btnText.innerHTML = 'üöÄ Generate';
      }
    };
  </script>
</body>
</html>
